{% extends '_base.html' %}

{% load static %} 
{% load i18n %} 
{% load crispy_forms_tags %} 
{% load comment_tags %} 
{% load jalali_tags %} 
{% load humanize %} 
{% load persian_translation_tags %}

{% block page_title %}{{product.title}}{% endblock %}


{% block content %}
<div class="container text-right my-5">

    <!-- Product Title -->
    <h1 class="mb-4">{{ product.title }}</h1>

    <!-- Product Image & Short Description -->
    <div class="row align-items-center mb-5">
        <div class="col-md-6 mb-3 mb-md-0 text-center">
            {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.title }}" class="img-fluid rounded shadow-sm" style="max-height:400px;">
            {% else %}
                <div class="bg-light border rounded p-5">تصویر موجود نیست</div>
            {% endif %}
        </div>
        <div class="col-md-6">
            <h4>توضیحات مختصر</h4>
            <p class="lead">{{ product.short_description }}</p>
            <div class="mt-4">
                <p class="h5">
                    <strong>{% trans "Price" %}:</strong> 
                    {{ product.price|intcomma:False|translate_number }} {% trans "$" %}
                </p>
                {# <p>موجودی: {{ product.inventory|translate_number }} عدد</p> #}
                <form action="{% url 'cart:cart_add' product.id %}" method="POST" class="mt-3">
                    {% csrf_token %}
                    <input type="hidden" name="quantity" value="1">
                    <button type="submit" class="btn btn-success btn-lg">
                        {% trans "Add to Cart" %}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <hr>

    <!-- Detailed Description -->
    <div class="product-description mb-5">
        <h4>توضیحات تفصیلی</h4>
        <div class="border p-4 rounded shadow-sm bg-white">
            {{ product.description|safe }}
        </div>
    </div>

    <!-- Comments Section -->
    <div class="comments mb-5">
        <h4>کامنت‌ها</h4>
        {% if product.comments.all|only_active_comments %}
            <ul class="list-unstyled">
                {% for comment in product.comments.all|only_active_comments|dictsortreversed:"datetime_created" %}
                    <li class="border rounded p-3 mb-3 shadow-sm">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>{{ comment.author.username }}</strong>
                            <small class="text-muted">{{ comment.datetime_created|to_jalali:"%Y %B %d"|translate_number }}</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <p class="mt-2">{{ comment.body }}</p>
                            <div class="rating">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= comment.stars|add:"0" %}
                                        <span style="color:#FFD700;">★</span>
                                    {% else %}
                                        <span style="color:#ccc;">★</span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">هنوز کامنتی ثبت نشده است.</p>
        {% endif %}
    </div>

    <!-- Comment Form -->
    {% if user.is_authenticated %}
        <div class="comment-form mb-5">
            <h5>ثبت نظر شما</h5>
            <form action="{% url 'comment_create' product.slug %}" method="POST">
                {% csrf_token %}
                {{ comment_form|crispy }}
                <button type="submit" class="btn btn-primary mt-2">{% trans "Submit" %}</button>
            </form>
        </div>
    {% else %}
        <p class="text-muted">
            {% trans 'To write your comment please ' %}
            <a href="{% url 'account_login' %}">{% trans 'Login' %}</a>
        </p>
    {% endif %}

</div>
{% endblock %}
